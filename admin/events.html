<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Events - ATICAS CAFE' Admin</title>
        <link rel="stylesheet" href="../css/style.css" />
        <link rel="stylesheet" href="../css/admin.css" />
        <link rel="stylesheet" href="../css/admin-professional.css" />
        <link
            href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <!-- Admin Navbar -->
        <nav class="admin-navbar">
            <div class="admin-navbar-left">
                <img
                    src="../images/aticas.png"
                    alt="Cafeteria Logo"
                    class="logo"
                />
                <span class="cafeteria-name">ATICAS CAFE' - Admin</span>
            </div>
            <div class="admin-navbar-right">
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            <div class="admin-navbar-tabs">
                <a href="index.html"
                    ><i class="fas fa-tachometer-alt"></i> Dashboard</a
                >
                <a href="orders.html"
                    ><i class="fas fa-clipboard-list"></i> Orders</a
                >
                <a href="bookings.html"
                    ><i class="fas fa-calendar-check"></i> Bookings</a
                >
                <a href="events.html" class="active"
                    ><i class="fas fa-calendar-alt"></i> Events</a
                >
                <a href="menu-management.html"
                    ><i class="fas fa-utensils"></i> Menu Management</a
                >
                <a href="employees.html"
                    ><i class="fas fa-users-cog"></i> Employees</a
                >
                <a href="admins.html"
                    ><i class="fas fa-user-shield"></i> Admins</a
                >
                <a href="reports.html"
                    ><i class="fas fa-chart-line"></i> Reports</a
                >
                <a href="payments.html"
                    ><i class="fas fa-credit-card"></i> Payments</a
                >
                <a href="place-order.html"
                    ><i class="fas fa-phone"></i> Place Order for Customer</a
                >
            </div>
        </nav>

        <!-- Admin Sidebar -->
        <div class="admin-sidebar">
            <a href="index.html"
                ><i class="fas fa-tachometer-alt"></i> Dashboard</a
            >
            <a href="orders.html"
                ><i class="fas fa-clipboard-list"></i> Orders</a
            >
            <a href="bookings.html"
                ><i class="fas fa-calendar-check"></i> Bookings</a
            >
            <a href="events.html" class="active"
                ><i class="fas fa-calendar-alt"></i> Events</a
            >
            <a href="menu-management.html"
                ><i class="fas fa-utensils"></i> Menu Management</a
            >
            <a href="employees.html"><i class="fas fa-users"></i> Employees</a>
            <a href="reports.html"><i class="fas fa-chart-bar"></i> Reports</a>
            <a href="admins.html"><i class="fas fa-user-shield"></i> Admins</a>
            <a href="payments.html"
                ><i class="fas fa-money-bill-wave"></i> Payments</a
            >
            <a href="place-order.html"
                ><i class="fas fa-phone"></i> Place Order for Customer</a
            >
        </div>

        <!-- Admin Content -->
        <div class="admin-content events-page-content">
            <div class="page-header">
                <h2><i class="fas fa-calendar-alt"></i> Event Management</h2>
                <p class="page-subtitle">
                    Create and manage upcoming events advertised on the homepage
                </p>
            </div>
            
            <div class="filter-controls">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="searchInput" placeholder="Search events..." style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 250px;">
                        <select id="typeFilter" class="filter-select">
                            <option value="">All Types</option>
                            <option value="catering">Catering</option>
                            <option value="tour">Tour</option>
                            <option value="graduation">Graduation</option>
                            <option value="wedding">Wedding</option>
                            <option value="corporate">Corporate</option>
                        </select>
                        <select id="statusFilter" class="filter-select">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <button id="addEventBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-plus"></i> Add Event
                    </button>
                </div>
            </div>

            <!-- Loading and Error Messages -->
            <div id="loading" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading events...</p>
            </div>
            <div id="errorMsg" class="notification error" style="display: none; position: static; margin-bottom: 1rem;"></div>

            <!-- Events Grid Container -->
            <div class="events-grid-container">
                <div id="eventsGrid" class="events-grid">
                    <!-- Events will be loaded via JavaScript -->
                </div>

                <!-- No Results Message -->
                <div id="noResults" class="no-results" style="display: none;">
                    <i class="fas fa-calendar-times"></i>
                    <h3>No events found</h3>
                    <p>Try adjusting your search or filter criteria</p>
                </div>
            </div>
        </div>

    <!-- Add/Edit Event Modal -->
    <div id="eventModal" class="modal" style="display: none; align-items: center !important;">
        <div class="modal-content" style="max-width: 600px; margin: auto !important;">
            <span class="close-modal" id="closeEventModal">&times;</span>
            <h3 id="modalTitle">Add New Event</h3>

            <form id="eventForm">
                <div class="form-group">
                    <label for="eventTitle">Event Title *</label>
                    <input type="text" id="eventTitle">
                </div>

                <div class="form-group">
                    <label for="eventDescription">Description *</label>
                    <textarea id="eventDescription" rows="4"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="eventDate">Event Date *</label>
                        <input type="datetime-local" id="eventDate">
                    </div>

                    <div class="form-group">
                        <label for="eventType">Event Type *</label>
                        <select id="eventType">
                            <option value="">Select Type</option>
                            <option value="catering">Catering</option>
                            <option value="tour">Tour</option>
                            <option value="graduation">Graduation</option>
                            <option value="wedding">Wedding</option>
                            <option value="corporate">Corporate</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="eventLocation">Location</label>
                        <input type="text" id="eventLocation" placeholder="Optional">
                    </div>

                    <div class="form-group">
                        <label for="eventCapacity">Capacity</label>
                        <input type="number" id="eventCapacity" min="1" placeholder="Optional">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="eventPrice">Starting Price (Ksh)</label>
                        <input type="number" id="eventPrice" min="0" placeholder="Optional">
                    </div>

                    <div class="form-group">
                        <label for="eventImage">Event Image *</label>
                        <input type="file" id="eventImage" accept="image/*">
                        <small style="color: #666; font-size: 0.8rem;">Upload a high-quality image for the event</small>
                    </div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="eventFixedPrice">
                        Fixed Price (non-negotiable)
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="eventFeatured">
                        Featured Event
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="eventActive" checked>
                        Active (visible on homepage)
                    </label>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" id="cancelEventBtn" class="submit-btn" style="background: #6c757d;">Cancel</button>
                    <button type="submit" class="submit-btn">Save Event</button>
                </div>
            </form>
        </div>

    <style>
            .event-modal-content {
                background: #fff;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
                max-width: 500px;
                width: 100%;
                max-height: 85vh;
                overflow: hidden;
                position: relative;
                animation: modalSlideIn 0.3s ease-out;
            }

            @keyframes modalSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(-30px) scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .modal-header {
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                padding: 1.5rem 2rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
            }

            .modal-header h3 {
                margin: 0;
                font-size: 1.4rem;
                font-weight: 600;
                color: white;
            }

            .modal-header .close-modal {
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 18px;
                transition: background 0.2s;
                position: static;
                float: none;
            }

            .modal-header .close-modal:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .modal-body {
                padding: 2rem;
                max-height: calc(85vh - 140px);
                overflow-y: auto;
                scrollbar-width: thin;
                scrollbar-color: #27ae60 #f1f1f1;
            }

            .modal-body::-webkit-scrollbar {
                width: 6px;
            }

            .modal-body::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }

            .modal-body::-webkit-scrollbar-thumb {
                background: #27ae60;
                border-radius: 3px;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
                margin-bottom: 1.2rem;
            }

            .form-row.checkbox-row {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .form-group {
                display: flex;
                flex-direction: column;
            }

            .form-group.full-width {
                grid-column: 1 / -1;
            }

            .form-group label {
                font-weight: 600;
                color: #2c3e50;
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                border: 1.5px solid #e0e6ed;
                border-radius: 8px;
                padding: 0.75rem;
                font-size: 0.9rem;
                transition: all 0.2s ease;
                background: #fafbfc;
            }

            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: #27ae60;
                background: #fff;
                box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
            }

            .form-group input[type="file"] {
                padding: 0.5rem;
                background: #fff;
                border: 1.5px dashed #27ae60;
                cursor: pointer;
            }

            .form-group textarea {
                resize: vertical;
                min-height: 80px;
            }

            .checkbox-group {
                display: flex;
                align-items: center;
                margin-bottom: 0.5rem;
            }

            .checkbox-label {
                display: flex !important;
                align-items: center;
                cursor: pointer;
                font-weight: 500 !important;
                color: #2c3e50 !important;
                margin-bottom: 0 !important;
            }

            .checkbox-label input[type="checkbox"] {
                display: none;
            }

            .checkmark {
                width: 20px;
                height: 20px;
                border: 2px solid #27ae60;
                border-radius: 4px;
                margin-right: 0.75rem;
                position: relative;
                transition: all 0.2s ease;
            }

            .checkbox-label input[type="checkbox"]:checked + .checkmark {
                background: #27ae60;
            }

            .checkbox-label input[type="checkbox"]:checked + .checkmark:after {
                content: "âœ“";
                position: absolute;
                color: white;
                font-size: 14px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .modal-footer {
                background: #f8f9fa;
                padding: 1.25rem 2rem;
                display: flex;
                justify-content: flex-end;
                gap: 0.75rem;
                border-top: 1px solid #e9ecef;
            }

            .btn {
                border: none;
                border-radius: 8px;
                padding: 0.75rem 1.5rem;
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s ease;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            .btn-primary {
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
            }

            .btn-primary:hover {
                background: linear-gradient(135deg, #229954, #27ae60);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover {
                background: #5a6268;
                transform: translateY(-1px);
            }

            /* Mobile Responsive */
            @media (max-width: 600px) {
                .event-modal-content {
                    max-width: 95%;
                    margin: 0.5rem;
                }

                .form-row {
                    grid-template-columns: 1fr;
                    gap: 0.8rem;
                }

                .modal-header {
                    padding: 1.2rem 1.5rem;
                }

                .modal-body {
                    padding: 1.5rem;
                }

                .modal-footer {
                    padding: 1rem 1.5rem;
                    flex-direction: column;
                }

                .btn {
                    width: 100%;
                    justify-content: center;
                }
            }
    </style>
    
    <!-- Events Page Specific Styles -->
    <style>
        /* Reduce sidebar size for events page */
        .admin-sidebar {
            width: 180px !important;
            padding-top: 1rem !important;
        }
        
        .admin-sidebar a {
            padding: 0.7rem 1rem !important;
            font-size: 0.95rem !important;
            gap: 0.6rem !important;
        }
        
        .admin-sidebar i {
            font-size: 1rem !important;
            width: 18px !important;
        }
        
        /* Adjust content area to account for smaller sidebar */
        .events-page-content {
            margin-left: 180px !important;
            margin-top: 60px !important;
            padding: 1rem 2rem 2rem 2rem !important;
            max-width: 100% !important;
            width: calc(100% - 180px) !important;
            box-sizing: border-box !important;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 60px);
        }
        
        /* Compact page header */
        .events-page-content .page-header {
            margin-bottom: 1rem !important;
            padding-bottom: 0.75rem !important;
        }
        
        .events-page-content .page-header h2 {
            font-size: 1.75rem !important;
            margin-bottom: 0.25rem !important;
        }
        
        .events-page-content .page-subtitle {
            font-size: 0.9rem !important;
            margin: 0 !important;
        }
        
        /* Compact filter controls */
        .events-page-content .filter-controls {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
        }
        
        /* Events Grid Container */
        .events-grid-container {
            width: 100%;
            padding: 0;
            margin: 0;
            position: relative;
            flex: 1;
        }
        
        /* Professional Events Grid */
        .events-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)) !important;
            gap: 1.5rem;
            width: 100%;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        
        /* Loading and error messages positioning */
        #loading,
        #errorMsg {
            position: relative !important;
            margin: 1rem 0 !important;
        }
        
        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .admin-sidebar {
                width: 160px !important;
            }
            
            .events-page-content {
                margin-left: 160px !important;
            }
            
            .events-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 1.2rem;
            }
        }
        
        @media (max-width: 992px) {
            .admin-sidebar {
                width: 140px !important;
            }
            
            .events-page-content {
                margin-left: 140px !important;
            }
            
            .events-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
            }
        }
        
        /* Ensure no overflow issues */
        body {
            overflow-x: hidden;
        }
        
        /* Better spacing for event cards */
        .event-card-admin {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            max-width: 100%;
        }
        
        .event-card-admin:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.12) !important;
        }
        
        /* No results styling */
        .no-results {
            text-align: center;
            padding: 3rem 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        /* Ensure events are visible immediately */
        @media (min-width: 992px) {
            .events-page-content {
                padding-top: 0.75rem !important;
            }
            
            .page-header {
                margin-bottom: 0.75rem !important;
            }
            
            .filter-controls {
                margin-bottom: 0.75rem !important;
            }
        }
    </style>
    <!-- Include image utilities and admin-events.js script -->
    <script src="../js/image-utils.js"></script>
    <script src="../js/admin-events.js"></script>
    <script>
    // Keep only the utility functions that might be used by other scripts
    function getAdminType() {
        let adminType = "cafeteria";
        try {
            const storedAdminData = JSON.parse(localStorage.getItem('adminData') || '{}');
            if (storedAdminData && storedAdminData.adminType) {
                adminType = storedAdminData.adminType;
            } else if (localStorage.getItem('adminType')) {
                adminType = localStorage.getItem('adminType');
            }
        } catch (e) {
            console.error('Error getting admin type:', e);
        }
        return adminType;
    }
    
    // Make these functions globally available for other scripts
    window.getAdminType = getAdminType;

    // Add event listeners when the DOM is fully loaded
    document.addEventListener("DOMContentLoaded", function() {
        // Check if user is authenticated
        const adminToken = localStorage.getItem("adminToken");
        if (!adminToken) {
            window.location.href = "admin-login.html";
            return;
        }

        // Add event listeners for the modal
        const addEventBtn = document.getElementById("addEventBtn");
        const closeModalBtn = document.getElementById("closeEventModal");
        const cancelBtn = document.getElementById("cancelEventBtn");
        const eventForm = document.getElementById("eventForm");
        const typeFilter = document.getElementById("typeFilter");
        const statusFilter = document.getElementById("statusFilter");
        const searchInput = document.getElementById("searchInput");
        const eventModal = document.getElementById("eventModal");
        
        // Add event listeners if elements exist
        if (addEventBtn) {
            addEventBtn.addEventListener("click", () => window.openEventModal());
        }
        
        if (closeModalBtn) {
            closeModalBtn.addEventListener("click", () => window.closeEventModal());
        }
        
        if (cancelBtn) {
            cancelBtn.addEventListener("click", () => window.closeEventModal());
        }
        
        if (eventForm) {
            eventForm.addEventListener("submit", (e) => {
                e.preventDefault();
                window.handleEventSubmit(e);
            });
        }
        
        if (typeFilter) {
            typeFilter.addEventListener("change", () => window.applyFilters());
        }
        
        if (statusFilter) {
            statusFilter.addEventListener("change", () => window.applyFilters());
        }
        
        if (searchInput) {
            searchInput.addEventListener("input", () => window.applyFilters());
        }
        
        // Click outside modal to close
        if (eventModal) {
            eventModal.addEventListener("click", (e) => {
                if (e.target === eventModal) {
                    window.closeEventModal();
                }
            });
        }
    });
    </script>
    <script>
    // Global variables for event management
    let allEvents = [];
    let editingEventId = null;

    // This function is now in admin-events.js
    // It's kept here for backward compatibility
    window.loadEvents = async function() {
                const loading = document.getElementById("loading");
                const errorMsg = document.getElementById("errorMsg");
                const adminToken = localStorage.getItem("adminToken");

                const adminType = getAdminType();

                loading.style.display = "block";
                errorMsg.style.display = "none";

                try {
                    const res = await fetch(
                        "https://aticas-backend.onrender.com/api/admin/events",
                        {
                            headers: {
                                Authorization: `Bearer ${adminToken}`,
                                "X-Admin-Type": adminType,
                            },
                        },
                    );

                    if (res.status === 401) {
                        // Token expired, redirect to login
                        window.location.href = "admin-login.html";
                        return;
                    }

                    const data = await res.json();

                    loading.style.display = "none";

                    if (!data.success) {
                        errorMsg.textContent =
                            data.error || "Failed to fetch events.";
                        errorMsg.style.display = "block";
                        return;
                    }

                    allEvents = data.events || [];
                    displayEvents(allEvents);
                } catch (err) {
                    loading.style.display = "none";
                    console.error("Error loading events:", err);

                    // Check if it's an authentication error
                    if (err.message && err.message.includes("401")) {
                        window.location.href = "admin-login.html";
                        return;
                    }

                    errorMsg.textContent = "Failed to load events. Please check your connection.";
                    errorMsg.style.display = "block";
                }
            }

            function displayEvents(events) {
                const grid = document.getElementById("eventsGrid");
                const noResults = document.getElementById("noResults");

                if (!grid) {
                    console.error("Events grid element not found");
                    return;
                }

                grid.innerHTML = "";

                if (events.length === 0) {
                    noResults.style.display = "block";
                    grid.style.display = "none";
                    return;
                }

                noResults.style.display = "none";
                grid.style.display = "grid"; // Ensure grid is visible

                events.forEach((event) => {
                    const eventDate = new Date(event.date).toLocaleDateString(
                        "en-US",
                        {
                            weekday: "long",
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                            hour: "2-digit",
                            minute: "2-digit",
                        },
                    );

                    // Use ImageUtils for consistent image URL construction
                    const imageUrl = window.ImageUtils 
                        ? window.ImageUtils.constructImageUrl(event.image, 'admin')
                        : (event.image && event.image.startsWith('/uploads/') 
                            ? `https://aticas-backend.onrender.com${event.image}` 
                            : '../images/1b.jpg');

                    console.log("Processing event image:", {
                        eventId: event._id,
                        eventTitle: event.title,
                        imageField: event.image,
                        constructedUrl: imageUrl
                    });

                    const eventCard = document.createElement("div");
                    eventCard.className = "event-card-admin";
                    eventCard.style.cssText = `
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                overflow: hidden;
                border: 2px solid ${event.active ? "#27ae60" : "#ddd"};
            `;

            // Use ImageUtils to create image element with comprehensive error handling
            const img = window.ImageUtils 
                ? window.ImageUtils.createImageElement(event.image, event.title || "Event Image", {
                    context: 'admin',
                    style: {
                        width: "100%",
                        height: "180px",
                        objectFit: "cover"
                    },
                    eventId: event._id,
                    onLoad: function(imgEl) {
                        console.log("Successfully loaded event image:", imageUrl);
                    },
                    onError: function(imgEl, errorInfo) {
                        console.group("Failed to load event image after all retries");
                        console.error("Event ID:", event._id);
                        console.error("Event Title:", event.title);
                        console.error("Original Path:", event.image || 'N/A');
                        console.error("Constructed URL:", imageUrl);
                        console.error("Error Info:", errorInfo);
                        console.error("Final Image Element:", imgEl);
                        console.groupEnd();
                        
                        // Verify image existence on server with detailed diagnostics
                        if (window.ImageUtils && event.image) {
                            window.ImageUtils.verifyImageExists(event.image).then(result => {
                                if (!result.exists) {
                                    console.group(`[ImageUtils] Image Verification Failed for Event: ${event.title}`);
                                    console.error('Event ID:', event._id);
                                    console.error('Image Path:', event.image);
                                    console.error('Verification Result:', result);
                                    if (result.similarFiles && result.similarFiles.length > 0) {
                                        console.warn('Similar files found in uploads directory:', result.similarFiles);
                                    }
                                    if (result.totalFilesInDir !== undefined) {
                                        console.info(`Total files in uploads directory: ${result.totalFilesInDir}`);
                                    }
                                    console.groupEnd();
                                    
                                    // Show admin-friendly message
                                    console.warn(`âš ï¸ Image missing for event "${event.title}". File: ${event.image}`);
                                    console.warn(`ðŸ’¡ Recommendation: Re-upload the image for this event or check if the file exists on the server.`);
                                } else {
                                    console.log(`âœ“ Image verified for event "${event.title}": ${event.image}`);
                                }
                            }).catch(err => {
                                console.warn(`[ImageUtils] Image verification failed:`, err);
                            });
                        }
                    }
                })
                : (() => {
                    // Fallback if ImageUtils not available
                    const fallbackImg = document.createElement("img");
                    fallbackImg.src = imageUrl;
                    fallbackImg.alt = event.title || "Event Image";
                    fallbackImg.style.width = "100%";
                    fallbackImg.style.height = "180px";
                    fallbackImg.style.objectFit = "cover";
                    fallbackImg.style.backgroundColor = "#f0f0f0";
                    fallbackImg.loading = "lazy";
                    fallbackImg.onerror = function() {
                        this.src = "../images/1b.jpg";
                        this.onerror = null;
                    };
                    return fallbackImg;
                })();

            // content container
            const content = document.createElement("div");
            content.style.padding = "1.5rem";

            // header row
            const headerRow = document.createElement("div");
            headerRow.style.display = "flex";
            headerRow.style.justifyContent = "space-between";
            headerRow.style.alignItems = "flex-start";
            headerRow.style.marginBottom = "1rem";

            const titleEl = document.createElement("h3");
            titleEl.style.margin = "0";
            titleEl.style.color = "#27ae60";
            titleEl.style.fontSize = "1.3rem";
            titleEl.textContent = event.title;

            const badgesWrap = document.createElement("div");
            badgesWrap.style.display = "flex";
            badgesWrap.style.gap = "0.5rem";

            if (event.fixedPrice) {
                const fixed = document.createElement("span");
                fixed.textContent = "FIXED PRICE";
                fixed.style.background = "#17a2b8";
                fixed.style.color = "white";
                fixed.style.padding = "0.2rem 0.5rem";
                fixed.style.borderRadius = "10px";
                fixed.style.fontSize = "0.8rem";
                fixed.style.fontWeight = "600";
                badgesWrap.appendChild(fixed);
            }

            if (event.featured) {
                const feat = document.createElement("span");
                feat.textContent = "FEATURED";
                feat.style.background = "#ffd700";
                feat.style.color = "#333";
                feat.style.padding = "0.2rem 0.5rem";
                feat.style.borderRadius = "10px";
                feat.style.fontSize = "0.8rem";
                feat.style.fontWeight = "600";
                badgesWrap.appendChild(feat);
            }

            const status = document.createElement("span");
            status.textContent = event.active ? "ACTIVE" : "INACTIVE";
            status.style.background = event.active ? "#d4edda" : "#f8d7da";
            status.style.color = event.active ? "#155724" : "#721c24";
            status.style.padding = "0.2rem 0.5rem";
            status.style.borderRadius = "10px";
            status.style.fontSize = "0.8rem";
            status.style.fontWeight = "600";
            badgesWrap.appendChild(status);

            headerRow.appendChild(titleEl);
            headerRow.appendChild(badgesWrap);
            content.appendChild(headerRow);

            // description
            const desc = document.createElement("p");
            desc.style.color = "#666";
            desc.style.marginBottom = "1rem";
            desc.style.lineHeight = "1.5";
            desc.textContent = event.description;
            content.appendChild(desc);

            // details grid
            const detailsGrid = document.createElement("div");
            detailsGrid.style.display = "grid";
            detailsGrid.style.gridTemplateColumns = "1fr 1fr";
            detailsGrid.style.gap = "1rem";
            detailsGrid.style.marginBottom = "1rem";

            const dateDiv = document.createElement("div");
            dateDiv.innerHTML = `<i class="fas fa-calendar" style="color: #27ae60; margin-right: 0.5rem;"></i>
                <strong>Date:</strong><br>
                <span style="font-size: 0.9rem; color: #555;">${eventDate}</span>`;

            const typeDiv = document.createElement("div");
            typeDiv.innerHTML = `<i class="fas fa-tag" style="color: #27ae60; margin-right: 0.5rem;"></i>
                <strong>Type:</strong><br>
                <span style="font-size: 0.9rem; color: #555; text-transform: capitalize;">${event.type}</span>`;

            detailsGrid.appendChild(dateDiv);
            detailsGrid.appendChild(typeDiv);
            content.appendChild(detailsGrid);

            // optional location
            if (event.location) {
                const locDiv = document.createElement("div");
                locDiv.style.marginBottom = "1rem";
                locDiv.innerHTML = `<i class="fas fa-map-marker-alt" style="color: #27ae60; margin-right: 0.5rem;"></i>
                    <strong>Location:</strong> ${event.location}`;
                content.appendChild(locDiv);
            }

            // capacity and price row
            const capPriceRow = document.createElement("div");
            capPriceRow.style.display = "flex";
            capPriceRow.style.justifyContent = "space-between";
            capPriceRow.style.alignItems = "center";
            capPriceRow.style.marginBottom = "1rem";

            const capSpan = document.createElement("span");
            capSpan.innerHTML = event.capacity ? `<i class="fas fa-users" style="color: #27ae60; margin-right: 0.5rem;"></i>Capacity: ${event.capacity}` : "&nbsp;";
            const priceSpan = document.createElement("span");
            priceSpan.innerHTML = event.price ? `<span style="color: #e67e22; font-weight: 600;">From Ksh ${event.price.toLocaleString()}</span>` : "&nbsp;";

            capPriceRow.appendChild(capSpan);
            capPriceRow.appendChild(priceSpan);
            content.appendChild(capPriceRow);

            // bookings section
            if (event.bookings && event.bookings.length > 0) {
                const bookingsToggle = document.createElement("div");
                bookingsToggle.style.marginTop = "1rem";
                bookingsToggle.style.padding = "0.5rem";
                bookingsToggle.style.background = "#f8f9fa";
                bookingsToggle.style.borderRadius = "8px";
                bookingsToggle.style.cursor = "pointer";
                bookingsToggle.style.display = "flex";
                bookingsToggle.style.justifyContent = "space-between";
                bookingsToggle.style.alignItems = "center";
                bookingsToggle.innerHTML = `
                    <span><i class="fas fa-calendar-check"></i> Bookings (${event.bookings.length})</span>
                    <i class="fas fa-chevron-down" id="toggle-${event._id}"></i>
                `;

                const bookingsList = document.createElement("div");
                bookingsList.id = `bookings-${event._id}`;
                bookingsList.style.display = "none";
                bookingsList.style.marginTop = "1rem";
                bookingsList.style.padding = "1rem";
                bookingsList.style.background = "#fff";
                bookingsList.style.borderRadius = "8px";
                bookingsList.style.border = "1px solid #dee2e6";

                // Populate bookings
                event.bookings.forEach(booking => {
                    const bookingItem = document.createElement("div");
                    bookingItem.style.padding = "0.75rem";
                    bookingItem.style.borderBottom = "1px solid #f0f0f0";
                    bookingItem.style.display = "flex";
                    bookingItem.style.justifyContent = "space-between";
                    bookingItem.style.alignItems = "center";

                    const statusClass = booking.status === 'confirmed' ? 'status-confirmed' :
                                      booking.status === 'cancelled' ? 'status-cancelled' : 'status-pending';

                    bookingItem.innerHTML = `
                        <div>
                            <strong>${booking.customerName}</strong> (${booking.attendees} people)<br>
                            <small>${booking.customerEmail} | ${booking.customerPhone}</small><br>
                            <small>Booked: ${new Date(booking.bookingDate).toLocaleDateString()}</small>
                        </div>
                        <div style="text-align: right;">
                            <span class="status-badge ${statusClass}" style="font-size: 0.8rem;">${booking.status.toUpperCase()}</span><br>
                            <select onchange="updateBookingStatus('${event._id}', '${booking._id}', this.value)" style="margin-top: 0.5rem; padding: 0.25rem; font-size: 0.8rem;">
                                <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                        </div>
                    `;

                    bookingsList.appendChild(bookingItem);
                });

                bookingsToggle.addEventListener("click", () => {
                    const isVisible = bookingsList.style.display !== "none";
                    bookingsList.style.display = isVisible ? "none" : "block";
                    document.getElementById(`toggle-${event._id}`).style.transform = isVisible ? "rotate(0deg)" : "rotate(180deg)";
                });

                content.appendChild(bookingsToggle);
                content.appendChild(bookingsList);
            }

            // actions
            const actionsRow = document.createElement("div");
            actionsRow.style.display = "flex";
            actionsRow.style.gap = "0.5rem";

            const editBtn = document.createElement("button");
            editBtn.className = "action-btn";
            editBtn.style.cssText = `
                flex: 1;
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                font-weight: 600;
                background: linear-gradient(135deg, #3498db, #2980b9);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            `;
            editBtn.innerHTML = `<i class="fas fa-edit"></i> Edit`;
            editBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                window.editEvent(event._id);
            });
            editBtn.onmouseover = function() { this.style.transform = "translateY(-2px)"; this.style.boxShadow = "0 4px 12px rgba(52, 152, 219, 0.4)"; };
            editBtn.onmouseout = function() { this.style.transform = "translateY(0)"; this.style.boxShadow = "none"; };

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "action-btn";
            deleteBtn.style.cssText = `
                flex: 1;
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                font-weight: 600;
                background: linear-gradient(135deg, #e74c3c, #c0392b);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            `;
            deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete`;
            deleteBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                window.deleteEvent(event._id);
            });
            deleteBtn.onmouseover = function() { this.style.transform = "translateY(-2px)"; this.style.boxShadow = "0 4px 12px rgba(231, 76, 60, 0.4)"; };
            deleteBtn.onmouseout = function() { this.style.transform = "translateY(0)"; this.style.boxShadow = "none"; };

            actionsRow.appendChild(editBtn);
            actionsRow.appendChild(deleteBtn);
            content.appendChild(actionsRow);

            // append to card
            eventCard.appendChild(img);
            eventCard.appendChild(content);

                    grid.appendChild(eventCard);
                });
            }

            function openEventModal(eventId = null) {
                editingEventId = eventId || null;
                const modal = document.getElementById("eventModal");
                const form = document.getElementById("eventForm");
                const modalTitle = document.getElementById("modalTitle");
                const imageInput = document.getElementById("eventImage");
                const imageLabel = imageInput ? imageInput.parentElement.querySelector("label") : null;

                if (eventId) {
                    modalTitle.textContent = "Edit Event";
                    const event = allEvents.find((e) => e._id === eventId);
                    if (event) {
                        const titleEl = document.getElementById("eventTitle");
                        const descEl = document.getElementById("eventDescription");
                        const dateEl = document.getElementById("eventDate");
                        const typeEl = document.getElementById("eventType");
                        const locEl = document.getElementById("eventLocation");
                        const capEl = document.getElementById("eventCapacity");
                        const priceEl = document.getElementById("eventPrice");
                        const fixedEl = document.getElementById("eventFixedPrice");
                        const featuredEl = document.getElementById("eventFeatured");
                        const activeEl = document.getElementById("eventActive");

                        if (titleEl) titleEl.value = event.title || "";
                        if (descEl) descEl.value = event.description || "";
                        if (dateEl && event.date) {
                            dateEl.value = new Date(event.date).toISOString().slice(0, 16);
                        }
                        if (typeEl) typeEl.value = event.type || "";
                        if (locEl) locEl.value = event.location || "";
                        if (capEl) capEl.value = event.capacity || "";
                        if (priceEl) priceEl.value = event.price || "";
                        if (fixedEl) fixedEl.checked = !!event.fixedPrice;
                        if (featuredEl) featuredEl.checked = !!event.featured;
                        if (activeEl) activeEl.checked = event.active !== false;

                        // Clear file input and show current image info
                        if (imageInput) imageInput.value = "";
                        if (imageLabel && event.image) {
                            const currentImageUrl =
                                event.image && event.image.startsWith("http")
                                    ? event.image
                                    : `https://aticas-backend.onrender.com${event.image}`;
                            imageLabel.innerHTML = `Event Image <small style="color: #666; font-size: 0.8rem;"><br>Current: <a href="${currentImageUrl}" target="_blank">View Image</a> | Upload new image to replace</small>`;
                        }
                    }
                } else {
                    modalTitle.textContent = "Add New Event";
                    if (form) form.reset();
                    const fixedEl = document.getElementById("eventFixedPrice");
                    const activeEl = document.getElementById("eventActive");
                    if (fixedEl) fixedEl.checked = false;
                    if (activeEl) activeEl.checked = true;
                    if (imageLabel) {
                        imageLabel.innerHTML = "Event Image *";
                    }
                }

                if (modal) {
                    modal.style.display = "block";
                    // Ensure the modal scrolls to the top to show all form details
                    requestAnimationFrame(() => {
                        const modalContent = document.querySelector(
                            "#eventModal .modal-content",
                        );
                        if (modalContent) modalContent.scrollTop = 0;
                    });
                }
            }

            function closeEventModal() {
                const modal = document.getElementById("eventModal");
                if (modal) {
                    modal.style.display = "none";
                }
                editingEventId = null;
            }

            async function handleEventSubmit(e) {
                e.preventDefault();

                // Check admin authentication first
                const adminToken = localStorage.getItem("adminToken");
                const adminType = getAdminType();

                if (!adminToken) {
                    showNotification(
                        "Authentication required. Please log in again.",
                        "error",
                    );
                    window.location.href = "admin-login.html";
                    return;
                }

                // Check required fields first
                const title = document
                    .getElementById("eventTitle")
                    .value.trim();
                const description = document
                    .getElementById("eventDescription")
                    .value.trim();
                const date = document.getElementById("eventDate").value;
                const type = document.getElementById("eventType").value;

                if (!title) {
                    showNotification("Please enter an event title", "error");
                    document.getElementById("eventTitle").focus();
                    return;
                }

                if (!description) {
                    showNotification(
                        "Please enter an event description",
                        "error",
                    );
                    document.getElementById("eventDescription").focus();
                    return;
                }

                if (!date) {
                    showNotification("Please select an event date", "error");
                    document.getElementById("eventDate").focus();
                    return;
                }

                if (!type) {
                    showNotification("Please select an event type", "error");
                    document.getElementById("eventType").focus();
                    return;
                }

                // Handle image upload
                const imageFile =
                    document.getElementById("eventImage").files[0];
                if (!imageFile && !editingEventId) {
                    // Only require image for new events
                    showNotification(
                        "Please select an image for the event",
                        "error",
                    );
                    document.getElementById("eventImage").focus();
                    return;
                }

                const formDataObj = new FormData();
                formDataObj.append("title", title);
                formDataObj.append("description", description);
                formDataObj.append("date", date);
                formDataObj.append("type", type);

                const location = document
                    .getElementById("eventLocation")
                    .value.trim();
                const capacity = document
                    .getElementById("eventCapacity")
                    .value.trim();
                const price = document
                    .getElementById("eventPrice")
                    .value.trim();

                if (location) {
                    formDataObj.append("location", location);
                }
                if (capacity) {
                    formDataObj.append("capacity", capacity);
                }
                if (price) {
                    formDataObj.append("price", price);
                }

                formDataObj.append(
                    "fixedPrice",
                    document.getElementById("eventFixedPrice").checked,
                );
                formDataObj.append(
                    "featured",
                    document.getElementById("eventFeatured").checked,
                );
                formDataObj.append(
                    "active",
                    document.getElementById("eventActive").checked,
                );

                if (imageFile) {
                    console.log("Image file details:", {
                        name: imageFile.name,
                        size: imageFile.size,
                        type: imageFile.type,
                    });
                    formDataObj.append("image", imageFile);
                }
                // For editing, if no new image is selected, the existing image will be kept

                const url = editingEventId
                    ? `https://aticas-backend.onrender.com/api/admin/events/${editingEventId}`
                    : "https://aticas-backend.onrender.com/api/admin/events";
                const method = editingEventId ? "PUT" : "POST";

                // Convert capacity and price to proper types
                const capacityValue =
                    document.getElementById("eventCapacity").value;
                const priceValue = document.getElementById("eventPrice").value;

                if (capacityValue) {
                    formDataObj.delete("capacity");
                    formDataObj.append("capacity", parseInt(capacityValue));
                }
                if (priceValue) {
                    formDataObj.delete("price");
                    formDataObj.append("price", parseFloat(priceValue));
                }

                // Add debugging logs
                console.log("Event submission data:");
                console.log("Method:", method);
                console.log("URL:", url);
                console.log("Admin token exists:", !!adminToken);
                console.log("Admin type:", adminType);
                console.log("FormData contents:");
                for (let [key, value] of formDataObj.entries()) {
                    console.log(`${key}:`, value);
                }

                try {
                    const response = await fetch(url, {
                        method,
                        headers: {
                            Authorization: `Bearer ${adminToken}`,
                            "X-Admin-Type": adminType || "cafeteria",
                        },
                        body: formDataObj,
                    });

                    if (response.status === 401) {
                        // Token expired, redirect to login
                        window.location.href = "admin-login.html";
                        return;
                    }

                    if (response.ok) {
                        const responseData = await response.json();
                        console.log("Event saved successfully:", responseData);
                        
                        closeEventModal();
                        await loadEvents();
                        showNotification(
                            editingEventId
                                ? "Event updated successfully"
                                : "Event created successfully",
                            "success",
                        );
                    } else {
                        const errorData = await response.text();
                        console.error("Server error response:", errorData);
                        console.error("Response status:", response.status);

                        let errorMessage = "Failed to save event";
                        try {
                            const errorJson = JSON.parse(errorData);
                            errorMessage =
                                errorJson.error ||
                                errorJson.message ||
                                errorMessage;
                            console.error("Parsed error:", errorJson);
                        } catch (e) {
                            console.error(
                                "Could not parse error response as JSON",
                            );
                            errorMessage = `Server error: ${response.status} - ${errorData}`;
                        }
                        showNotification(errorMessage, "error");
                    }
                } catch (error) {
                    console.error("Save error:", error);
                    showNotification(
                        "Network error: Failed to save event",
                        "error",
                    );
                }
            }

            // Make functions globally accessible
            window.editEvent = async function(eventId) {
                openEventModal(eventId);
            };

            window.deleteEvent = async function(eventId) {
                if (!confirm("Are you sure you want to delete this event? This action cannot be undone."))
                    return;

                const adminToken = localStorage.getItem("adminToken");
                const adminType = getAdminType();

                if (!adminToken) {
                    showNotification("Authentication required. Please log in again.", "error");
                    window.location.href = "admin-login.html";
                    return;
                }

                try {
                    const response = await fetch(
                        `https://aticas-backend.onrender.com/api/admin/events/${eventId}`,
                        {
                            method: "DELETE",
                            headers: {
                                Authorization: `Bearer ${adminToken}`,
                                "X-Admin-Type": adminType,
                            },
                        },
                    );

                    if (response.status === 401) {
                        // Token expired, redirect to login
                        window.location.href = "admin-login.html";
                        return;
                    }

                    if (response.ok) {
                        await window.loadEvents();
                        showNotification(
                            "Event deleted successfully",
                            "success",
                        );
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        showNotification(errorData.error || "Failed to delete event", "error");
                    }
                } catch (error) {
                    console.error("Delete error:", error);
                    showNotification("Failed to delete event. Please try again.", "error");
                }
            };

            // Make other functions globally accessible
            window.openEventModal = openEventModal;
            window.closeEventModal = closeEventModal;
            window.applyFilters = applyFilters;
            window.handleEventSubmit = handleEventSubmit;

            function applyFilters() {
                const typeFilter = document.getElementById("typeFilter").value;
                const statusFilter =
                    document.getElementById("statusFilter").value;
                const searchTerm = document
                    .getElementById("searchInput")
                    .value.toLowerCase();

                let filtered = allEvents;

                if (typeFilter) {
                    filtered = filtered.filter((e) => e.type === typeFilter);
                }

                if (statusFilter) {
                    const isActive = statusFilter === "active";
                    filtered = filtered.filter((e) => e.active === isActive);
                }

                if (searchTerm) {
                    filtered = filtered.filter(
                        (e) =>
                            e.title.toLowerCase().includes(searchTerm) ||
                            e.description.toLowerCase().includes(searchTerm),
                    );
                }

                displayEvents(filtered);
            }

            async function updateBookingStatus(eventId, bookingId, newStatus) {
                try {
                    const adminToken = localStorage.getItem("adminToken");
                    const adminType = getAdminType();

                    const response = await fetch(`https://aticas-backend.onrender.com/api/admin/events/${eventId}/bookings/${bookingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${adminToken}`,
                            'X-Admin-Type': adminType
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        showNotification(`Booking status updated to ${newStatus}`, "success");
                        // Reload events to refresh the data
                        await loadEvents();
                    } else {
                        const error = await response.json();
                        showNotification(error.error || "Failed to update booking status", "error");
                    }
                } catch (error) {
                    console.error("Error updating booking status:", error);
                    showNotification("Failed to update booking status", "error");
                }
            }

            function showNotification(message, type) {
                const notification = document.createElement("div");
                notification.className = `notification ${type}`;
                notification.innerHTML = `
            <i class="fas ${type === "success" ? "fa-check-circle" : "fa-exclamation-circle"}"></i>
            ${message}
        `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
        </script>
        <script>
        // Initialize page when DOM is loaded
        document.addEventListener("DOMContentLoaded", function() {
            // Load events on page load
            if (typeof window.loadEvents === 'function') {
                window.loadEvents();
            }
        });
        </script>
        <script src="../js/admin.js"></script>
        <script src="../js/script.js"></script>
    </body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - ATICAS CAFE'</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
    <style>
        .booking-history-section {
            margin-top: 80px;
            padding: 4rem 2rem;
            display: flex;
            justify-content: center;
        }

        .booking-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(39,174,96,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            width: 100%;
            max-width: 700px;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px dashed #27ae60;
        }

        .booking-id {
            font-size: 1rem;
            color: #666;
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            display: inline-block;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-admin_review { background: #cce5ff; color: #004085; }
        .status-price_proposed { background: #d1ecf1; color: #0c5460; }
        .status-customer_accepted { background: #d4edda; color: #155724; }
        .status-customer_rejected { background: #f8d7da; color: #721c24; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-in_progress { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        .booking-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            margin-bottom: 0.8rem;
        }

        .detail-label {
            font-weight: 600;
            color: #27ae60;
            margin-right: 0.5rem;
        }

        .price-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid #27ae60;
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .price-item.total {
            font-size: 1.2rem;
            font-weight: bold;
            color: #27ae60;
            border-top: 1px solid #dee2e6;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        .feedback-section {
            margin-top: 2rem;
            border-top: 1px solid #dee2e6;
            padding-top: 1.5rem;
        }

        .feedback-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .feedback-item.admin {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
        }

        .feedback-item.customer {
            background: #f0f8e7;
            border-left: 4px solid #27ae60;
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .feedback-from {
            font-weight: bold;
            color: #27ae60;
        }

        .feedback-from.admin {
            color: #0066cc;
        }

        .feedback-timestamp {
            font-size: 0.8rem;
            color: #666;
        }

        .proposed-price {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .proposed-price .price {
            font-size: 1.2rem;
            font-weight: bold;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #219150;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .feedback-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .feedback-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
        }

        .feedback-textarea:focus {
            border-color: #27ae60;
            outline: none;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: #f8f9fa;
            border-radius: 16px;
            border: 2px dashed #dee2e6;
        }

        .empty-state i {
            font-size: 4rem;
            color: #adb5bd;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: #adb5bd;
            margin-bottom: 2rem;
        }

        .guest-notice {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .guest-notice h3 {
            color: #856404;
            margin-bottom: 1rem;
        }

        .guest-notice p {
            color: #856404;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .booking-details {
                grid-template-columns: 1fr;
            }

            .booking-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .action-buttons {
                flex-direction: column;
            }

            .price-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-left">
            <img src="images/1b.jpg" alt="Cafeteria Logo" class="logo">
            <span class="cafeteria-name">ATICAS CAFE'</span>
        </div>
        <div class="navbar-center">
            <div class="moving-text">Welcome to <b></b>Aticas Cafe'</b>. Your Hospitality Partner - Enjoy our freshly prepared meals at affordable prices! Open from Mon - Sat @ 6:00am - 12:00am</div>
        </div>
        <div class="navbar-right">
            <a href="cart.html" class="cart-icon"><i class="fas fa-shopping-cart"></i><span class="cart-count" id="cartCount">0</span></a>
            <button class="login-btn" id="loginBtn">Login</button>
            <div class="hamburger-menu" id="hamburgerMenu">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="index.html"><i class="fas fa-home"></i> Home</a>
        <a href="about.html"><i class="fas fa-info-circle"></i> About Us</a>
        <a href="menu.html"><i class="fas fa-utensils"></i> Menu</a>
        <a href="butchery.html"><i class="fas fa-double-knives"></i> Butchery</a>
        <a href="our-services.html"><i class="fas fa-concierge-bell"></i> Our Services</a>
        <a href="orders.html"><i class="fas fa-receipt"></i> My Orders</a>
        <a href="bookings.html"><i class="fas fa-calendar-check"></i> My Bookings</a>
        <a href="contact.html"><i class="fas fa-envelope"></i> Contact</a>
        <a href="gallery.html"><i class="fas fa-gallery"></i> Gallery</a>
    </div>

    <!-- Bookings Content -->
    <section class="booking-history-section">
        <div style="width:100%;max-width:800px;">
            <!-- Header -->
            <div style="text-align:center;margin-bottom:3rem;">
                <h1 class="typewriter-on-scroll" style="font-size:2.5rem;color:#27ae60;margin-bottom:1rem;font-family:'UnifrakturCook',cursive;">My Bookings</h1>
                <p class="typewriter-on-scroll" style="color:#666;font-size:1.1rem;">Track your bookings and manage price negotiations</p>
            </div>

            <!-- Loading State -->
            <div id="loadingState" style="text-align:center;padding:2rem;">
                <i class="fas fa-spinner fa-spin" style="font-size:2rem;color:#27ae60;"></i>
                <p style="margin-top:1rem;color:#666;">Loading your bookings...</p>
            </div>

            <!-- Bookings Container -->
            <div id="bookingsContainer"></div>
        </div>
    </section>

    <!-- Price Response Modal -->
    <div id="priceResponseModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;overflow-y:auto;">
        <div style="max-width:500px;margin:5rem auto;background:white;border-radius:16px;padding:2rem;">
            <div style="text-align:center;margin-bottom:2rem;">
                <h3 id="modalTitle" style="color:#27ae60;margin-bottom:0.5rem;">Respond to Price Proposal</h3>
                <p id="modalSubtitle" style="color:#666;">Please provide your feedback</p>
            </div>

            <div id="proposedPriceDisplay" style="background:#fff3cd;border-radius:8px;padding:1rem;margin-bottom:1.5rem;text-align:center;">
                <span style="font-size:0.9rem;color:#856404;">Proposed Amount:</span>
                <div id="proposedAmount" style="font-size:1.5rem;font-weight:bold;color:#856404;">Ksh 0</div>
            </div>

            <div id="counterOfferSection" style="display:none;margin-bottom:1.5rem;">
                <label style="display:block;margin-bottom:0.5rem;font-weight:600;color:#27ae60;">Counter Offer Amount (Ksh):</label>
                <input type="number" id="counterOfferAmount" min="0" step="0.01" placeholder="Enter your counter offer" style="width:100%;padding:0.75rem;border:2px solid #e1e5e9;border-radius:8px;font-size:1rem;">
            </div>

            <textarea id="responseMessage" placeholder="Add your message (optional)..." style="width:100%;min-height:100px;padding:1rem;border:2px solid #e1e5e9;border-radius:8px;margin-bottom:1.5rem;resize:vertical;"></textarea>

            <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
                <button id="acceptPrice" class="btn btn-primary">
                    <i class="fas fa-check"></i> Accept Price
                </button>
                <button id="counterOfferBtn" class="btn btn-warning" style="background:#f39c12;color:white;">
                    <i class="fas fa-handshake"></i> Make Counter Offer
                </button>
                <button id="rejectPrice" class="btn btn-danger">
                    <i class="fas fa-times"></i> Reject Price
                </button>
                <button id="cancelResponse" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;overflow-y:auto;">
        <div style="max-width:500px;margin:5rem auto;background:white;border-radius:16px;padding:2rem;">
            <div style="text-align:center;margin-bottom:2rem;">
                <h3 style="color:#27ae60;margin-bottom:0.5rem;">Proceed to Payment</h3>
                <p style="color:#666;">Complete your booking payment</p>
            </div>

            <div style="background:#f8f9fa;border-radius:8px;padding:1.5rem;margin-bottom:1.5rem;">
                <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                    <span>Deposit Required (70%):</span>
                    <span id="depositAmount" style="font-weight:bold;color:#27ae60;">Ksh 0</span>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:1.1rem;font-weight:bold;">
                    <span>Total Amount:</span>
                    <span id="totalPaymentAmount" style="color:#27ae60;">Ksh 0</span>
                </div>
            </div>

            <div style="margin-bottom:1.5rem;">
                <label style="display:block;margin-bottom:0.5rem;font-weight:600;color:#27ae60;">Payment Method:</label>
                <select id="paymentMethod" style="width:100%;padding:0.75rem;border:2px solid #e1e5e9;border-radius:8px;font-size:1rem;">
                    <option value="mpesa">M-Pesa</option>
                    <option value="card">Credit/Debit Card</option>
                    <option value="bank">Bank Transfer</option>
                </select>
            </div>

            <div style="display:flex;gap:1rem;justify-content:center;">
                <button id="proceedToPayment" class="btn btn-primary">
                    <i class="fas fa-credit-card"></i> Proceed to Payment
                </button>
                <button id="cancelPayment" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="social-icons">
            <a href="#"><i class="fab fa-facebook"></i></a>
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-linkedin"></i></a>
            <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
        <p class="built-by">
            Developed by Coders Hub
            <img src="images/coders-hub-logo.png" alt="Coders Hub Logo" style="height:24px;vertical-align:middle;margin:0 6px;" />
            | Contact: 0791486568 / 0714003218
        </p>
        <p class="copyright">
            &copy; 2025 Aticas Cafe. All rights reserved.
        </p>
    </footer>

    <script src="js/script.js"></script>
    <script>
        const bookingsContainer = document.getElementById('bookingsContainer');
        const loadingState = document.getElementById('loadingState');
        const token = localStorage.getItem('userToken');

        let allBookings = [];
        let currentBooking = null;

        // Modal elements
        const priceResponseModal = document.getElementById('priceResponseModal');
        const paymentModal = document.getElementById('paymentModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalSubtitle = document.getElementById('modalSubtitle');
        const proposedAmount = document.getElementById('proposedAmount');
        const responseMessage = document.getElementById('responseMessage');
        const acceptPrice = document.getElementById('acceptPrice');
        const rejectPrice = document.getElementById('rejectPrice');
        const cancelResponse = document.getElementById('cancelResponse');
        const counterOfferBtn = document.getElementById('counterOfferBtn');
        const counterOfferSection = document.getElementById('counterOfferSection');
        const counterOfferAmount = document.getElementById('counterOfferAmount');
        const proceedToPayment = document.getElementById('proceedToPayment');
        const cancelPayment = document.getElementById('cancelPayment');
        const depositAmount = document.getElementById('depositAmount');
        const totalPaymentAmount = document.getElementById('totalPaymentAmount');
        const paymentMethod = document.getElementById('paymentMethod');

        function getStatusBadge(status) {
            const statusMap = {
                'pending': 'Pending Review',
                'admin_review': 'Under Review',
                'price_proposed': 'Price Proposed',
                'customer_accepted': 'Price Accepted',
                'customer_rejected': 'Price Rejected',
                'confirmed': 'Confirmed',
                'in_progress': 'In Progress',
                'completed': 'Completed',
                'cancelled': 'Cancelled'
            };

            const statusText = statusMap[status] || status.charAt(0).toUpperCase() + status.slice(1);
            return `<span class="status-badge status-${status.replace('_', '-')}">${statusText}</span>`;
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatCurrency(amount) {
            return `Ksh ${Number(amount || 0).toLocaleString()}`;
        }

        function createBookingCard(booking) {
            const isEventBooking = booking.type === 'catering' || booking.type === 'tour';
            const canRespondToPrice = booking.status === 'price_proposed';

            let bookingDetails = '';
            if (isEventBooking) {
                if (booking.type === 'catering') {
                    bookingDetails = `
                        <div class="detail-item">
                            <span class="detail-label">Event Type:</span>
                            ${booking.eventType || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Guests:</span>
                            ${booking.guests || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Location:</span>
                            ${booking.location || 'N/A'}
                        </div>
                    `;
                } else if (booking.type === 'tour') {
                    bookingDetails = `
                        <div class="detail-item">
                            <span class="detail-label">Package:</span>
                            ${booking.package || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">People:</span>
                            ${booking.people || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Pickup:</span>
                            ${booking.pickup || 'N/A'}
                        </div>
                    `;
                }
            }

            // Price section
            const currentAmount = booking.finalAmount || booking.totalAmount || 0;
            const originalAmount = booking.originalAmount || 0;
            const depositRequired = booking.depositRequired || 0;

            let priceSection = `
                <div class="price-section">
                    <h4 style="margin:0 0 1rem 0;color:#27ae60;">Pricing Details</h4>
            `;

            if (originalAmount > 0 && originalAmount !== currentAmount) {
                priceSection += `
                    <div class="price-item">
                        <span>Original Estimate:</span>
                        <span style="text-decoration:line-through;color:#999;">${formatCurrency(originalAmount)}</span>
                    </div>
                `;
            }

            priceSection += `
                <div class="price-item">
                    <span>Current Amount:</span>
                    <span>${formatCurrency(currentAmount)}</span>
                </div>
                <div class="price-item">
                    <span>Deposit Required (70%):</span>
                    <span>${formatCurrency(depositRequired)}</span>
                </div>
                <div class="price-item total">
                    <span>Total Amount:</span>
                    <span>${formatCurrency(currentAmount)}</span>
                </div>
            </div>
            `;

            // Feedback section
            let feedbackSection = '';
            if (booking.feedback && booking.feedback.length > 0) {
                feedbackSection = `
                    <div class="feedback-section">
                        <h4 style="margin:0 0 1rem 0;color:#27ae60;">Communication History</h4>
                `;

                booking.feedback.forEach(feedback => {
                    const isAdmin = feedback.from === 'admin';
                    feedbackSection += `
                        <div class="feedback-item ${feedback.from}">
                            <div class="feedback-header">
                                <span class="feedback-from ${feedback.from}">
                                    ${isAdmin ? `Admin ${feedback.adminName || ''}` : 'You'}
                                </span>
                                <span class="feedback-timestamp">${formatDateTime(feedback.timestamp)}</span>
                            </div>
                            <div class="feedback-message">${feedback.message}</div>
                            ${feedback.proposedAmount ? `
                                <div class="proposed-price">
                                    <i class="fas fa-tag"></i> Proposed Price:
                                    <span class="price">${formatCurrency(feedback.proposedAmount)}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                feedbackSection += '</div>';
            }

            // Action buttons
            let actionButtons = '';
            if (canRespondToPrice) {
                actionButtons = `
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openPriceResponseModal('${booking._id}', '${currentAmount}')">
                            <i class="fas fa-reply"></i> Respond to Price
                        </button>
                    </div>
                `;
            }

            return `
                <div class="booking-card">
                    <div class="booking-header">
                        <div>
                            <div class="booking-id">Booking #${booking._id}</div>
                            <div style="margin-top:0.5rem;">
                                <strong>Date:</strong> ${formatDateTime(booking.date)}
                            </div>
                        </div>
                        <div>
                            ${getStatusBadge(booking.status)}
                        </div>
                    </div>

                    <div class="booking-details">
                        <div>
                            <div class="detail-item">
                                <span class="detail-label">Name:</span>
                                ${booking.name}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Phone:</span>
                                ${booking.phone}
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Email:</span>
                                ${booking.email}
                            </div>
                        </div>
                        <div>
                            ${bookingDetails}
                            ${booking.notes ? `
                                <div class="detail-item">
                                    <span class="detail-label">Notes:</span>
                                    ${booking.notes}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${priceSection}
                    ${feedbackSection}
                    ${actionButtons}
                </div>
            `;
        }

        function openPriceResponseModal(bookingId, amount) {
            currentBooking = allBookings.find(b => b._id === bookingId);
            if (!currentBooking) return;

            proposedAmount.textContent = formatCurrency(amount);
            responseMessage.value = '';
            counterOfferSection.style.display = 'none';
            counterOfferAmount.value = '';
            counterOfferBtn.textContent = 'Make Counter Offer';
            priceResponseModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closePriceResponseModal() {
            priceResponseModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentBooking = null;
            responseMessage.value = '';
        }

        async function respondToPrice(accept, counterOfferAmount = null) {
            if (!currentBooking) return;

            let message = responseMessage.value.trim();
            let endpoint = accept ? 'accept-price' : 'reject-price';
            let requestBody = { message };

            if (counterOfferAmount !== null) {
                // Counter offer
                endpoint = 'counter-offer';
                requestBody.counterOfferAmount = counterOfferAmount;
                message = message || `Counter offer: ${formatCurrency(counterOfferAmount)}`;
            } else {
                message = message || (accept ? 'Price accepted' : 'Price rejected');
            }

            requestBody.message = message;

            try {
                const response = await fetch(`https://aticas-backend.onrender.com/api/bookings/${currentBooking._id}/${endpoint}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Failed to ${counterOfferAmount !== null ? 'make counter offer' : (accept ? 'accept' : 'reject')} price`);
                }

                const result = await response.json();

                if (result.success) {
                    closePriceResponseModal();
                    loadBookings(); // Refresh bookings
                    const action = counterOfferAmount !== null ? 'counter offer submitted' : `price ${accept ? 'accepted' : 'rejected'}`;
                    alert(`✅ ${action} successfully!`);
                } else {
                    throw new Error(result.error || 'Operation failed');
                }
            } catch (error) {
                console.error('Error responding to price:', error);
                const action = counterOfferAmount !== null ? 'make counter offer' : (accept ? 'accept' : 'reject');
                alert(`❌ Failed to ${action}: ${error.message}`);
            }
        }

        function showPaymentModal(amount) {
            const deposit = Math.round(amount * 0.7);
            depositAmount.textContent = formatCurrency(deposit);
            totalPaymentAmount.textContent = formatCurrency(amount);
            paymentModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closePaymentModal() {
            paymentModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function processPayment() {
            if (!currentBooking) return;

            const method = paymentMethod.value;
            const amount = currentBooking.finalAmount || currentBooking.totalAmount;

            // For now, just show a success message and update booking status
            // In a real implementation, this would integrate with payment processors
            alert(`✅ Payment initiated via ${method}. Amount: ${formatCurrency(amount)}\n\nNote: This is a demo. Actual payment integration would be implemented here.`);

            closePaymentModal();

            // Update booking status to confirmed (assuming payment was successful)
            try {
                const response = await fetch(`https://aticas-backend.onrender.com/api/bookings/${currentBooking._id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : undefined
                    },
                    body: JSON.stringify({
                        status: 'confirmed',
                        paymentStatus: 'deposit_paid'
                    })
                });

                if (response.ok) {
                    loadBookings(); // Refresh bookings
                }
            } catch (error) {
                console.error('Error updating booking status:', error);
            }
        }

        function displayBookings() {
            loadingState.style.display = 'none';

            if (allBookings.length === 0) {
                if (token) {
                    bookingsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <h3>No Bookings Yet</h3>
                            <p>You haven't made any bookings yet. Start by booking our catering services!</p>
                            <a href="outside-catering.html" class="btn btn-primary">
                                <i class="fas fa-calendar-plus"></i> Book Catering
                            </a>
                        </div>
                    `;
                } else {
                    bookingsContainer.innerHTML = `
                        <div class="guest-notice">
                            <h3><i class="fas fa-info-circle"></i> Login to View Your Bookings</h3>
                            <p>To view and manage your bookings, including price negotiations, please login to your account.</p>
                            <button onclick="document.getElementById('loginBtn').click()" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </button>
                        </div>
                    `;
                }
            } else {
                const bookingCards = allBookings.map(booking => createBookingCard(booking)).join('');
                bookingsContainer.innerHTML = bookingCards;
            }
        }

        async function loadBookings() {
            try {
                loadingState.style.display = 'block';

                if (token) {
                    // Logged-in user: fetch their bookings
                    const response = await fetch('https://aticas-backend.onrender.com/api/bookings/user', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        allBookings = result.bookings || [];
                    } else {
                        throw new Error('Failed to fetch bookings');
                    }
                } else {
                    // Guest user: no bookings to show
                    allBookings = [];
                }

                displayBookings();
            } catch (error) {
                console.error('Error loading bookings:', error);
                loadingState.style.display = 'none';
                bookingsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle" style="color:#dc3545;"></i>
                        <h3>Failed to Load Bookings</h3>
                        <p>Unable to load your bookings. Please check your connection and try again.</p>
                        <button onclick="loadBookings()" class="btn btn-primary">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Event listeners
        cancelResponse.addEventListener('click', closePriceResponseModal);
        acceptPrice.addEventListener('click', () => {
            const amount = currentBooking.finalAmount || currentBooking.totalAmount;
            closePriceResponseModal();
            showPaymentModal(amount);
        });
        rejectPrice.addEventListener('click', () => respondToPrice(false));
        counterOfferBtn.addEventListener('click', () => {
            if (counterOfferSection.style.display === 'none') {
                counterOfferSection.style.display = 'block';
                counterOfferBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Counter Offer';
                counterOfferAmount.focus();
            } else {
                const amount = parseFloat(counterOfferAmount.value);
                if (!amount || amount <= 0) {
                    alert('Please enter a valid counter offer amount.');
                    counterOfferAmount.focus();
                    return;
                }
                respondToPrice(null, amount);
            }
        });
        proceedToPayment.addEventListener('click', processPayment);
        cancelPayment.addEventListener('click', closePaymentModal);

        // Close modal when clicking outside
        priceResponseModal.addEventListener('click', function(e) {
            if (e.target === priceResponseModal) {
                closePriceResponseModal();
            }
        });

        paymentModal.addEventListener('click', function(e) {
            if (e.target === paymentModal) {
                closePaymentModal();
            }
        });

        // Initialize
        loadBookings();
    </script>
</body>
</html>
